<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>YouTube Player</title>
    <style>
      body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: black; }
      #player { width: 100%; height: 100%; }
    </style>
  </head>
  <body>
    <div id="player"></div>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
      let player;
      const params = new URLSearchParams(window.location.search);
      const videoId = params.get('videoId');
      const showControls = params.get('controls') === '1' ? 1 : 0;
      const muted = params.get('muted') === '1';
      const volume = parseInt(params.get('volume') || '50', 10);
      
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '100%',
          width: '100%',
          videoId: videoId,
          playerVars: {
            autoplay: 1,
            controls: showControls,
            loop: 1,
            playlist: videoId, // Required for loop
            modestbranding: 1,
            rel: 0,
            fs: 0,
            playsinline: 1,
            enablejsapi: 1,
            origin: window.location.origin, // Explicit origin
            mute: muted ? 1 : 0
          },
          events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
            onError: onPlayerError
          }
        });
      }

      function onPlayerReady(event) {
        if (!muted) {
          event.target.setVolume(volume);
        }
        event.target.playVideo();
      }

      function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.ENDED) {
          event.target.playVideo(); 
        }
      }
      
      function onPlayerError(event) {
        console.error('YouTube Player Error:', event.data);
      }
      
      // Listen for messages from parent
      window.addEventListener('message', (event) => {
        if (!player || !player.setVolume) return;
        
        const data = event.data;
        if (data.type === 'setVolume') {
          player.setVolume(data.value);
        } else if (data.type === 'setMuted') {
          if (data.value) player.mute();
          else player.unMute();
        } else if (data.type === 'loadVideo') {
          player.loadVideoById(data.value);
        }
      });
    </script>
  </body>
</html>